from app.extractors import MetarCollectiveExtractor, MetarExtractor
import pytest


class TestMetarExtractor:

    @pytest.fixture
    def extractor(self):
        return MetarExtractor()

    @pytest.mark.asyncio
    async def test_extract_metar_iwxxm30(self, extractor):
        assert await extractor.extract(METAR_IWXXM30) == {
            'geometry': {'coordinates': [0.0, 0.0], 'type': 'Point'},
            'issueTime': '2020-08-13T21:35:00Z',
            'locationIdentifier': 'K41U'
        }


class TestMetarCollectiveExtractor:

    @pytest.fixture
    def extractor(self):
        return MetarCollectiveExtractor()

    @pytest.mark.asyncio
    async def test_extract_iwxxm30(self, extractor):
        assert await extractor.extract(METAR_COLLECTIVE_IWXXM30) == {
            'count': 2,
            'extracted': [
                {
                    'geometry': {'coordinates': [0.0, 0.0], 'type': 'Point'},
                    'issueTime': '2020-08-13T21:35:00Z',
                    'locationIdentifier': 'K41U'
                },
                {
                    'geometry': {'coordinates': [0.0, 0.0], 'type': 'Point'},
                    'issueTime': '2020-08-13T21:30:00Z',
                    'locationIdentifier': 'KCNI'
                }
            ]
        }


METAR_IWXXM30 = b'''\
<?xml version='1.0' encoding='UTF-8'?><MeteorologicalBulletin xmlns="http://def.wmo.int/collect/2014" xmlns:gml="http://www.opengis.net/gml/3.2" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://def.wmo.int/collect/2014 http://schemas.wmo.int/collect/1.2/collect.xsd" gml:id="uuid.84826a40-9c99-4aa1-8236-51e5b72a4486"><meteorologicalInformation><iwxxm:METAR xmlns:aixm="http://www.aixm.aero/schema/5.1.1" xmlns:iwxxm="http://icao.int/iwxxm/3.0" xmlns:gml="http://www.opengis.net/gml/3.2" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://icao.int/iwxxm/3.0 http://schemas.wmo.int/iwxxm/3.0/iwxxm.xsd http://www.weather.gov/iwxxm-us/3.0 https://nws.weather.gov/schemas/iwxxm-us/3.0/metarSpeci.xsd" reportStatus="NORMAL" automatedStation="true" permissibleUsage="OPERATIONAL" translationCentreName="NCEP Central Operations" translationCentreDesignator="KWNO" translationTime="2020-09-03T12:02:41Z" translatedBulletinReceptionTime="2020-09-03T12:02:41Z" translatedBulletinID="SAUS99KWBC132143" gml:id="uuid.f956bc0a-a65e-4368-bd81-27b2a9fff3e4" xmlns:iwxxm-us="http://www.weather.gov/iwxxm-us/3.0"><iwxxm:issueTime><gml:TimeInstant gml:id="uuid.5d37d62f-b4ae-420d-8d8b-1696dc6eb86f"><gml:timePosition>2020-08-13T21:35:00Z</gml:timePosition></gml:TimeInstant></iwxxm:issueTime><iwxxm:aerodrome><aixm:AirportHeliport gml:id="uuid.0873c2c0-c919-4b44-930f-a73a51db5d95"><aixm:timeSlice><aixm:AirportHeliportTimeSlice gml:id="uuid.d8bdfb2e-411b-409b-b207-a130dc1abd07"><gml:validTime /><aixm:interpretation>SNAPSHOT</aixm:interpretation><aixm:designator>K41U</aixm:designator><aixm:ARP><aixm:ElevatedPoint srsDimension="2" srsName="http://www.opengis.net/def/crs/EPSG/0/4326" axisLabels="Lat Long" gml:id="uuid.88d3c287-e08a-4e64-beac-2fd3d1fab4c4"><gml:pos>0.0 0.0</gml:pos></aixm:ElevatedPoint></aixm:ARP></aixm:AirportHeliportTimeSlice></aixm:timeSlice></aixm:AirportHeliport></iwxxm:aerodrome><iwxxm:observationTime xlink:href="#uuid.5d37d62f-b4ae-420d-8d8b-1696dc6eb86f" /><iwxxm:observation><iwxxm:MeteorologicalAerodromeObservation gml:id="uuid.d8ba9b43-83a6-4437-a99d-2dc641bdfdeb" cloudAndVisibilityOK="false"><iwxxm:airTemperature uom="Cel">34.9</iwxxm:airTemperature><iwxxm:dewpointTemperature uom="Cel">4.3</iwxxm:dewpointTemperature><iwxxm:qnh uom="hPa">1014.6</iwxxm:qnh><iwxxm:surfaceWind><iwxxm:AerodromeSurfaceWind variableWindDirection="false"><iwxxm:meanWindDirection uom="deg">230</iwxxm:meanWindDirection><iwxxm:meanWindSpeed uom="[kn_i]">23</iwxxm:meanWindSpeed><iwxxm:windGustSpeed uom="[kn_i]">30</iwxxm:windGustSpeed></iwxxm:AerodromeSurfaceWind></iwxxm:surfaceWind><iwxxm:visibility><iwxxm:AerodromeHorizontalVisibility><iwxxm:prevailingVisibility uom="m">10000</iwxxm:prevailingVisibility><iwxxm:prevailingVisibilityOperator>ABOVE</iwxxm:prevailingVisibilityOperator></iwxxm:AerodromeHorizontalVisibility></iwxxm:visibility><iwxxm:cloud><iwxxm:AerodromeCloud><iwxxm:layer><iwxxm:CloudLayer><iwxxm:amount xsi:nil="true" nilReason="http://codes.wmo.int/common/nil/notDetectedByAutoSystem" xlink:title="CLR" /><iwxxm:base nilReason="http://codes.wmo.int/common/nil/notDetectedByAutoSystem" xsi:nil="true" uom="N/A" /></iwxxm:CloudLayer></iwxxm:layer></iwxxm:AerodromeCloud></iwxxm:cloud><iwxxm:extension><Addendum xmlns="http://www.weather.gov/iwxxm-us/3.0"><observingSystemType xlink:href="https://codes.nws.noaa.gov/FMH-1/ObservingSystemType/AO1" /></Addendum></iwxxm:extension></iwxxm:MeteorologicalAerodromeObservation></iwxxm:observation></iwxxm:METAR></meteorologicalInformation><bulletinIdentifier>A_LAUS99KWBC132143_C_KWBC_20200903160241.xml</bulletinIdentifier></MeteorologicalBulletin>
'''  # noqa: E501

METAR_COLLECTIVE_IWXXM30 = b'''\
<?xml version='1.0' encoding='UTF-8'?><MeteorologicalBulletin xmlns="http://def.wmo.int/collect/2014" xmlns:gml="http://www.opengis.net/gml/3.2" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://def.wmo.int/collect/2014 http://schemas.wmo.int/collect/1.2/collect.xsd" gml:id="uuid.84826a40-9c99-4aa1-8236-51e5b72a4486"><meteorologicalInformation><iwxxm:METAR xmlns:aixm="http://www.aixm.aero/schema/5.1.1" xmlns:iwxxm="http://icao.int/iwxxm/3.0" xmlns:gml="http://www.opengis.net/gml/3.2" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://icao.int/iwxxm/3.0 http://schemas.wmo.int/iwxxm/3.0/iwxxm.xsd http://www.weather.gov/iwxxm-us/3.0 https://nws.weather.gov/schemas/iwxxm-us/3.0/metarSpeci.xsd" reportStatus="NORMAL" automatedStation="true" permissibleUsage="OPERATIONAL" translationCentreName="NCEP Central Operations" translationCentreDesignator="KWNO" translationTime="2020-09-03T12:02:41Z" translatedBulletinReceptionTime="2020-09-03T12:02:41Z" translatedBulletinID="SAUS99KWBC132143" gml:id="uuid.f956bc0a-a65e-4368-bd81-27b2a9fff3e4" xmlns:iwxxm-us="http://www.weather.gov/iwxxm-us/3.0"><iwxxm:issueTime><gml:TimeInstant gml:id="uuid.5d37d62f-b4ae-420d-8d8b-1696dc6eb86f"><gml:timePosition>2020-08-13T21:35:00Z</gml:timePosition></gml:TimeInstant></iwxxm:issueTime><iwxxm:aerodrome><aixm:AirportHeliport gml:id="uuid.0873c2c0-c919-4b44-930f-a73a51db5d95"><aixm:timeSlice><aixm:AirportHeliportTimeSlice gml:id="uuid.d8bdfb2e-411b-409b-b207-a130dc1abd07"><gml:validTime /><aixm:interpretation>SNAPSHOT</aixm:interpretation><aixm:designator>K41U</aixm:designator><aixm:ARP><aixm:ElevatedPoint srsDimension="2" srsName="http://www.opengis.net/def/crs/EPSG/0/4326" axisLabels="Lat Long" gml:id="uuid.88d3c287-e08a-4e64-beac-2fd3d1fab4c4"><gml:pos>0.0 0.0</gml:pos></aixm:ElevatedPoint></aixm:ARP></aixm:AirportHeliportTimeSlice></aixm:timeSlice></aixm:AirportHeliport></iwxxm:aerodrome><iwxxm:observationTime xlink:href="#uuid.5d37d62f-b4ae-420d-8d8b-1696dc6eb86f" /><iwxxm:observation><iwxxm:MeteorologicalAerodromeObservation gml:id="uuid.d8ba9b43-83a6-4437-a99d-2dc641bdfdeb" cloudAndVisibilityOK="false"><iwxxm:airTemperature uom="Cel">34.9</iwxxm:airTemperature><iwxxm:dewpointTemperature uom="Cel">4.3</iwxxm:dewpointTemperature><iwxxm:qnh uom="hPa">1014.6</iwxxm:qnh><iwxxm:surfaceWind><iwxxm:AerodromeSurfaceWind variableWindDirection="false"><iwxxm:meanWindDirection uom="deg">230</iwxxm:meanWindDirection><iwxxm:meanWindSpeed uom="[kn_i]">23</iwxxm:meanWindSpeed><iwxxm:windGustSpeed uom="[kn_i]">30</iwxxm:windGustSpeed></iwxxm:AerodromeSurfaceWind></iwxxm:surfaceWind><iwxxm:visibility><iwxxm:AerodromeHorizontalVisibility><iwxxm:prevailingVisibility uom="m">10000</iwxxm:prevailingVisibility><iwxxm:prevailingVisibilityOperator>ABOVE</iwxxm:prevailingVisibilityOperator></iwxxm:AerodromeHorizontalVisibility></iwxxm:visibility><iwxxm:cloud><iwxxm:AerodromeCloud><iwxxm:layer><iwxxm:CloudLayer><iwxxm:amount xsi:nil="true" nilReason="http://codes.wmo.int/common/nil/notDetectedByAutoSystem" xlink:title="CLR" /><iwxxm:base nilReason="http://codes.wmo.int/common/nil/notDetectedByAutoSystem" xsi:nil="true" uom="N/A" /></iwxxm:CloudLayer></iwxxm:layer></iwxxm:AerodromeCloud></iwxxm:cloud><iwxxm:extension><Addendum xmlns="http://www.weather.gov/iwxxm-us/3.0"><observingSystemType xlink:href="https://codes.nws.noaa.gov/FMH-1/ObservingSystemType/AO1" /></Addendum></iwxxm:extension></iwxxm:MeteorologicalAerodromeObservation></iwxxm:observation></iwxxm:METAR></meteorologicalInformation><meteorologicalInformation><iwxxm:METAR xmlns:aixm="http://www.aixm.aero/schema/5.1.1" xmlns:iwxxm="http://icao.int/iwxxm/3.0" xmlns:gml="http://www.opengis.net/gml/3.2" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://icao.int/iwxxm/3.0 http://schemas.wmo.int/iwxxm/3.0/iwxxm.xsd http://www.weather.gov/iwxxm-us/3.0 https://nws.weather.gov/schemas/iwxxm-us/3.0/metarSpeci.xsd" reportStatus="NORMAL" automatedStation="true" permissibleUsage="OPERATIONAL" translationCentreName="NCEP Central Operations" translationCentreDesignator="KWNO" translationTime="2020-09-03T16:02:41Z" translatedBulletinReceptionTime="2020-09-03T16:02:41Z" translatedBulletinID="SAUS99KWBC132143" gml:id="uuid.740a906b-3979-4af6-adfb-1a1491df938b" xmlns:iwxxm-us="http://www.weather.gov/iwxxm-us/3.0"><iwxxm:issueTime><gml:TimeInstant gml:id="uuid.b1a01c04-1410-46cf-8081-525e467929b0"><gml:timePosition>2020-08-13T21:30:00Z</gml:timePosition></gml:TimeInstant></iwxxm:issueTime><iwxxm:aerodrome><aixm:AirportHeliport gml:id="uuid.60438b3e-b6b6-48c7-9537-2761015ab38d"><aixm:timeSlice><aixm:AirportHeliportTimeSlice gml:id="uuid.293102bd-c4a2-4e5e-8fd7-1e476e8f20d2"><gml:validTime /><aixm:interpretation>SNAPSHOT</aixm:interpretation><aixm:designator>KCNI</aixm:designator><aixm:locationIndicatorICAO>KCNI</aixm:locationIndicatorICAO><aixm:ARP><aixm:ElevatedPoint srsDimension="2" srsName="http://www.opengis.net/def/crs/EPSG/0/4326" axisLabels="Lat Long" gml:id="uuid.77d987d4-b6e2-4cf6-965c-ab50970e2d30"><gml:pos>0.0 0.0</gml:pos></aixm:ElevatedPoint></aixm:ARP></aixm:AirportHeliportTimeSlice></aixm:timeSlice></aixm:AirportHeliport></iwxxm:aerodrome><iwxxm:observationTime xlink:href="#uuid.b1a01c04-1410-46cf-8081-525e467929b0" /><iwxxm:observation><iwxxm:MeteorologicalAerodromeObservation gml:id="uuid.79f3c1c1-41d1-4d2c-acaa-10ff03d0e8ac" cloudAndVisibilityOK="false"><iwxxm:airTemperature uom="Cel">31</iwxxm:airTemperature><iwxxm:dewpointTemperature uom="Cel">17</iwxxm:dewpointTemperature><iwxxm:qnh uom="hPa">1013.9</iwxxm:qnh><iwxxm:surfaceWind><iwxxm:AerodromeSurfaceWind variableWindDirection="false"><iwxxm:meanWindDirection uom="deg">300</iwxxm:meanWindDirection><iwxxm:meanWindSpeed uom="[kn_i]">5</iwxxm:meanWindSpeed></iwxxm:AerodromeSurfaceWind></iwxxm:surfaceWind><iwxxm:visibility><iwxxm:AerodromeHorizontalVisibility><iwxxm:prevailingVisibility uom="m">10000</iwxxm:prevailingVisibility><iwxxm:prevailingVisibilityOperator>ABOVE</iwxxm:prevailingVisibilityOperator></iwxxm:AerodromeHorizontalVisibility></iwxxm:visibility><iwxxm:cloud><iwxxm:AerodromeCloud><iwxxm:layer><iwxxm:CloudLayer><iwxxm:amount xsi:nil="true" nilReason="http://codes.wmo.int/common/nil/notDetectedByAutoSystem" xlink:title="CLR" /><iwxxm:base nilReason="http://codes.wmo.int/common/nil/notDetectedByAutoSystem" xsi:nil="true" uom="N/A" /></iwxxm:CloudLayer></iwxxm:layer></iwxxm:AerodromeCloud></iwxxm:cloud><iwxxm:extension><Addendum xmlns="http://www.weather.gov/iwxxm-us/3.0"><observingSystemType xlink:href="https://codes.nws.noaa.gov/FMH-1/ObservingSystemType/AO2" /></Addendum></iwxxm:extension></iwxxm:MeteorologicalAerodromeObservation></iwxxm:observation></iwxxm:METAR></meteorologicalInformation><bulletinIdentifier>A_LAUS99KWBC132143_C_KWBC_20200903160241.xml</bulletinIdentifier></MeteorologicalBulletin>
'''  # noqa: E501

SPECI_IWXXM30 = b'''\
'''  # noqa: E501


COLLECTIVE_IWXXM30 = b'''\
'''  # noqa: E501
