from contextlib import ExitStack
from unittest.mock import patch
from uuid import UUID
import xml.etree.ElementTree as etree  # noqa: N813 -- for lxml compatibility

from app.converters import ConversionInput, WtaConverter
from app.media_types import MediaTypes
import pendulum
import pytest
from tests.conftest import compare_xml
import time_machine


class TestWtaConverter:

    @pytest.mark.asyncio
    async def test_convert(self):
        converter = WtaConverter()
        with ExitStack() as stack:
            stack.enter_context(time_machine.travel(pendulum.parse('2020-08-13T17:00:00Z')))
            stack.enter_context(patch('uuid.uuid4', return_value=UUID('a36a2138-2c09-473e-bd0d-916531537b02')))
            results = await converter.convert([ConversionInput(TAC, MediaTypes.TEXT_PLAIN)])

        xml_tree = etree.fromstring(XML)
        for result in results:
            result_tree = etree.fromstring(result.data)
            assert compare_xml(xml_tree, result_tree)


TAC = b'''\
\r\r\n
000\r\r\n
FBHW33 KWNO 131954\r\r\n
FD3HW3\r\r\n
DATA BASED ON 131800Z\r\r\n
VALID 140600Z   FOR USE 0300-1200Z. TEMPS NEG ABV 24000\r\r\n
\r\r\n
FT  1000 1500 2000 3000    6000    9000   12000   15000   18000   24000\r\r\n
LIH 0714 0716 0716 0717 0817+12 0911+09 1006+08 0506+02 3309-06 3021-17\r\r\n
HNL 0616 0617 0618 0721 0816+13 0913+09 1306+06 9900+02 3007-06 2923-17\r\r\n
LNY           0721 0819 0913+13 1011+10 1107+07 9900+02 9900-05 2822-16\r\r\n
OGG 0716 0718 0719 0822 1017+13 1011+10 1108+07 9900+02 9900-05 2823-16\r\r\n
KOA 0605 0706 9900 9900 9900+14 9900+10 9900+07 9900+03 9900-04 2820-16\r\r\n
ITO 9900 0705 0706 1013 1110+12 1007+09 1010+09 1311+02 0105-04 2719-15\r\r\n
\r\r\n
'''  # noqa: E501

XML = b'''\
<?xml version="1.0" encoding="UTF-8"?><uswx:WindsAndTemperaturesAloftForecast xmlns:gml="http://www.opengis.net/gml/3.2" xmlns:uswx="http://nws.weather.gov/schemas/USWX/1.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://nws.weather.gov/schemas/USWX/1.0 https://nws.weather.gov/schemas/uswx/1.0/wndtmpalft.xsd" gml:id="wta-a36a2138-2c09-473e-bd0d-916531537b02"><uswx:issuingOffice>National Centers for Environmental Prediction</uswx:issuingOffice><uswx:resultTime gml:id="wta-a36a2138-2c09-473e-bd0d-916531537b02"><gml:timePosition>2020-08-14T06:00:00Z</gml:timePosition></uswx:resultTime><uswx:validTime gml:id="wta-a36a2138-2c09-473e-bd0d-916531537b02"><gml:begin><gml:TimeInstant gml:id="wta-a36a2138-2c09-473e-bd0d-916531537b02"><gml:timePosition>2020-08-14T03:00:00Z</gml:timePosition></gml:TimeInstant></gml:begin><gml:end><gml:TimeInstant gml:id="wta-a36a2138-2c09-473e-bd0d-916531537b02"><gml:timePosition>2020-08-14T12:00:00Z</gml:timePosition></gml:TimeInstant></gml:end></uswx:validTime><uswx:WTForecastResults><uswx:SamplingAtPoint><uswx:samplingPointIdentifier>LIH</uswx:samplingPointIdentifier><uswx:samplingPointLocation><gml:Point gml:id="wta-a36a2138-2c09-473e-bd0d-916531537b02" axisLabels="Lat Long" srsDimension="2" srsName="http://www.opengis.net/def/crs/EPSG/0/4326"><gml:pos>21.983 -158.667</gml:pos></gml:Point></uswx:samplingPointLocation><uswx:results><uswx:WindTempAtLevel><uswx:windDirection uom="deg">70</uswx:windDirection><uswx:windSpeed uom="[kn_i]">14</uswx:windSpeed><uswx:level uom="[ft_i]">1000</uswx:level></uswx:WindTempAtLevel></uswx:results><uswx:results><uswx:WindTempAtLevel><uswx:windDirection uom="deg">70</uswx:windDirection><uswx:windSpeed uom="[kn_i]">16</uswx:windSpeed><uswx:level uom="[ft_i]">1500</uswx:level></uswx:WindTempAtLevel></uswx:results><uswx:results><uswx:WindTempAtLevel><uswx:windDirection uom="deg">70</uswx:windDirection><uswx:windSpeed uom="[kn_i]">16</uswx:windSpeed><uswx:level uom="[ft_i]">2000</uswx:level></uswx:WindTempAtLevel></uswx:results><uswx:results><uswx:WindTempAtLevel><uswx:windDirection uom="deg">70</uswx:windDirection><uswx:windSpeed uom="[kn_i]">17</uswx:windSpeed><uswx:level uom="[ft_i]">3000</uswx:level></uswx:WindTempAtLevel></uswx:results><uswx:results><uswx:WindTempAtLevel><uswx:windDirection uom="deg">80</uswx:windDirection><uswx:windSpeed uom="[kn_i]">17</uswx:windSpeed><uswx:temperature uom="Cel">12</uswx:temperature><uswx:level uom="[ft_i]">6000</uswx:level></uswx:WindTempAtLevel></uswx:results><uswx:results><uswx:WindTempAtLevel><uswx:windDirection uom="deg">90</uswx:windDirection><uswx:windSpeed uom="[kn_i]">11</uswx:windSpeed><uswx:temperature uom="Cel">9</uswx:temperature><uswx:level uom="[ft_i]">9000</uswx:level></uswx:WindTempAtLevel></uswx:results><uswx:results><uswx:WindTempAtLevel><uswx:windDirection uom="deg">100</uswx:windDirection><uswx:windSpeed uom="[kn_i]">6</uswx:windSpeed><uswx:temperature uom="Cel">8</uswx:temperature><uswx:level uom="[ft_i]">12000</uswx:level></uswx:WindTempAtLevel></uswx:results><uswx:results><uswx:WindTempAtLevel><uswx:windDirection uom="deg">50</uswx:windDirection><uswx:windSpeed uom="[kn_i]">6</uswx:windSpeed><uswx:temperature uom="Cel">2</uswx:temperature><uswx:level uom="[ft_i]">15000</uswx:level></uswx:WindTempAtLevel></uswx:results><uswx:results><uswx:WindTempAtLevel><uswx:windDirection uom="deg">330</uswx:windDirection><uswx:windSpeed uom="[kn_i]">9</uswx:windSpeed><uswx:temperature uom="Cel">-6</uswx:temperature><uswx:level uom="[ft_i]">18000</uswx:level></uswx:WindTempAtLevel></uswx:results><uswx:results><uswx:WindTempAtLevel><uswx:windDirection uom="deg">300</uswx:windDirection><uswx:windSpeed uom="[kn_i]">21</uswx:windSpeed><uswx:temperature uom="Cel">-17</uswx:temperature><uswx:level uom="[ft_i]">24000</uswx:level></uswx:WindTempAtLevel></uswx:results></uswx:SamplingAtPoint></uswx:WTForecastResults><uswx:WTForecastResults><uswx:SamplingAtPoint><uswx:samplingPointIdentifier>HNL</uswx:samplingPointIdentifier><uswx:samplingPointLocation><gml:Point gml:id="wta-a36a2138-2c09-473e-bd0d-916531537b02" axisLabels="Lat Long" srsDimension="2" srsName="http://www.opengis.net/def/crs/EPSG/0/4326"><gml:pos>21.317 -156.083</gml:pos></gml:Point></uswx:samplingPointLocation><uswx:results><uswx:WindTempAtLevel><uswx:windDirection uom="deg">60</uswx:windDirection><uswx:windSpeed uom="[kn_i]">16</uswx:windSpeed><uswx:level uom="[ft_i]">1000</uswx:level></uswx:WindTempAtLevel></uswx:results><uswx:results><uswx:WindTempAtLevel><uswx:windDirection uom="deg">60</uswx:windDirection><uswx:windSpeed uom="[kn_i]">17</uswx:windSpeed><uswx:level uom="[ft_i]">1500</uswx:level></uswx:WindTempAtLevel></uswx:results><uswx:results><uswx:WindTempAtLevel><uswx:windDirection uom="deg">60</uswx:windDirection><uswx:windSpeed uom="[kn_i]">18</uswx:windSpeed><uswx:level uom="[ft_i]">2000</uswx:level></uswx:WindTempAtLevel></uswx:results><uswx:results><uswx:WindTempAtLevel><uswx:windDirection uom="deg">70</uswx:windDirection><uswx:windSpeed uom="[kn_i]">21</uswx:windSpeed><uswx:level uom="[ft_i]">3000</uswx:level></uswx:WindTempAtLevel></uswx:results><uswx:results><uswx:WindTempAtLevel><uswx:windDirection uom="deg">80</uswx:windDirection><uswx:windSpeed uom="[kn_i]">16</uswx:windSpeed><uswx:temperature uom="Cel">13</uswx:temperature><uswx:level uom="[ft_i]">6000</uswx:level></uswx:WindTempAtLevel></uswx:results><uswx:results><uswx:WindTempAtLevel><uswx:windDirection uom="deg">90</uswx:windDirection><uswx:windSpeed uom="[kn_i]">13</uswx:windSpeed><uswx:temperature uom="Cel">9</uswx:temperature><uswx:level uom="[ft_i]">9000</uswx:level></uswx:WindTempAtLevel></uswx:results><uswx:results><uswx:WindTempAtLevel><uswx:windDirection uom="deg">130</uswx:windDirection><uswx:windSpeed uom="[kn_i]">6</uswx:windSpeed><uswx:temperature uom="Cel">6</uswx:temperature><uswx:level uom="[ft_i]">12000</uswx:level></uswx:WindTempAtLevel></uswx:results><uswx:results><uswx:WindTempAtLevel lightAndVariable="true"><uswx:temperature uom="Cel">2</uswx:temperature><uswx:level uom="[ft_i]">15000</uswx:level></uswx:WindTempAtLevel></uswx:results><uswx:results><uswx:WindTempAtLevel><uswx:windDirection uom="deg">300</uswx:windDirection><uswx:windSpeed uom="[kn_i]">7</uswx:windSpeed><uswx:temperature uom="Cel">-6</uswx:temperature><uswx:level uom="[ft_i]">18000</uswx:level></uswx:WindTempAtLevel></uswx:results><uswx:results><uswx:WindTempAtLevel><uswx:windDirection uom="deg">290</uswx:windDirection><uswx:windSpeed uom="[kn_i]">23</uswx:windSpeed><uswx:temperature uom="Cel">-17</uswx:temperature><uswx:level uom="[ft_i]">24000</uswx:level></uswx:WindTempAtLevel></uswx:results></uswx:SamplingAtPoint></uswx:WTForecastResults><uswx:WTForecastResults><uswx:SamplingAtPoint><uswx:samplingPointIdentifier>LNY</uswx:samplingPointIdentifier><uswx:samplingPointLocation><gml:Point gml:id="wta-a36a2138-2c09-473e-bd0d-916531537b02" axisLabels="Lat Long" srsDimension="2" srsName="http://www.opengis.net/def/crs/EPSG/0/4326"><gml:pos>20.783 -155.050</gml:pos></gml:Point></uswx:samplingPointLocation><uswx:results><uswx:WindTempAtLevel><uswx:level uom="[ft_i]">1000</uswx:level></uswx:WindTempAtLevel></uswx:results><uswx:results><uswx:WindTempAtLevel><uswx:windDirection uom="deg">70</uswx:windDirection><uswx:windSpeed uom="[kn_i]">21</uswx:windSpeed><uswx:level uom="[ft_i]">1500</uswx:level></uswx:WindTempAtLevel></uswx:results><uswx:results><uswx:WindTempAtLevel><uswx:windDirection uom="deg">80</uswx:windDirection><uswx:windSpeed uom="[kn_i]">19</uswx:windSpeed><uswx:level uom="[ft_i]">2000</uswx:level></uswx:WindTempAtLevel></uswx:results><uswx:results><uswx:WindTempAtLevel><uswx:windDirection uom="deg">90</uswx:windDirection><uswx:windSpeed uom="[kn_i]">13</uswx:windSpeed><uswx:temperature uom="Cel">13</uswx:temperature><uswx:level uom="[ft_i]">3000</uswx:level></uswx:WindTempAtLevel></uswx:results><uswx:results><uswx:WindTempAtLevel><uswx:windDirection uom="deg">100</uswx:windDirection><uswx:windSpeed uom="[kn_i]">11</uswx:windSpeed><uswx:temperature uom="Cel">10</uswx:temperature><uswx:level uom="[ft_i]">6000</uswx:level></uswx:WindTempAtLevel></uswx:results><uswx:results><uswx:WindTempAtLevel><uswx:windDirection uom="deg">110</uswx:windDirection><uswx:windSpeed uom="[kn_i]">7</uswx:windSpeed><uswx:temperature uom="Cel">7</uswx:temperature><uswx:level uom="[ft_i]">9000</uswx:level></uswx:WindTempAtLevel></uswx:results><uswx:results><uswx:WindTempAtLevel lightAndVariable="true"><uswx:temperature uom="Cel">2</uswx:temperature><uswx:level uom="[ft_i]">12000</uswx:level></uswx:WindTempAtLevel></uswx:results><uswx:results><uswx:WindTempAtLevel lightAndVariable="true"><uswx:temperature uom="Cel">-5</uswx:temperature><uswx:level uom="[ft_i]">15000</uswx:level></uswx:WindTempAtLevel></uswx:results><uswx:results><uswx:WindTempAtLevel><uswx:windDirection uom="deg">280</uswx:windDirection><uswx:windSpeed uom="[kn_i]">22</uswx:windSpeed><uswx:temperature uom="Cel">-16</uswx:temperature><uswx:level uom="[ft_i]">18000</uswx:level></uswx:WindTempAtLevel></uswx:results></uswx:SamplingAtPoint></uswx:WTForecastResults><uswx:WTForecastResults><uswx:SamplingAtPoint><uswx:samplingPointIdentifier>OGG</uswx:samplingPointIdentifier><uswx:samplingPointLocation><gml:Point gml:id="wta-a36a2138-2c09-473e-bd0d-916531537b02" axisLabels="Lat Long" srsDimension="2" srsName="http://www.opengis.net/def/crs/EPSG/0/4326"><gml:pos>20.900 -155.567</gml:pos></gml:Point></uswx:samplingPointLocation><uswx:results><uswx:WindTempAtLevel><uswx:windDirection uom="deg">70</uswx:windDirection><uswx:windSpeed uom="[kn_i]">16</uswx:windSpeed><uswx:level uom="[ft_i]">1000</uswx:level></uswx:WindTempAtLevel></uswx:results><uswx:results><uswx:WindTempAtLevel><uswx:windDirection uom="deg">70</uswx:windDirection><uswx:windSpeed uom="[kn_i]">18</uswx:windSpeed><uswx:level uom="[ft_i]">1500</uswx:level></uswx:WindTempAtLevel></uswx:results><uswx:results><uswx:WindTempAtLevel><uswx:windDirection uom="deg">70</uswx:windDirection><uswx:windSpeed uom="[kn_i]">19</uswx:windSpeed><uswx:level uom="[ft_i]">2000</uswx:level></uswx:WindTempAtLevel></uswx:results><uswx:results><uswx:WindTempAtLevel><uswx:windDirection uom="deg">80</uswx:windDirection><uswx:windSpeed uom="[kn_i]">22</uswx:windSpeed><uswx:level uom="[ft_i]">3000</uswx:level></uswx:WindTempAtLevel></uswx:results><uswx:results><uswx:WindTempAtLevel><uswx:windDirection uom="deg">100</uswx:windDirection><uswx:windSpeed uom="[kn_i]">17</uswx:windSpeed><uswx:temperature uom="Cel">13</uswx:temperature><uswx:level uom="[ft_i]">6000</uswx:level></uswx:WindTempAtLevel></uswx:results><uswx:results><uswx:WindTempAtLevel><uswx:windDirection uom="deg">100</uswx:windDirection><uswx:windSpeed uom="[kn_i]">11</uswx:windSpeed><uswx:temperature uom="Cel">10</uswx:temperature><uswx:level uom="[ft_i]">9000</uswx:level></uswx:WindTempAtLevel></uswx:results><uswx:results><uswx:WindTempAtLevel><uswx:windDirection uom="deg">110</uswx:windDirection><uswx:windSpeed uom="[kn_i]">8</uswx:windSpeed><uswx:temperature uom="Cel">7</uswx:temperature><uswx:level uom="[ft_i]">12000</uswx:level></uswx:WindTempAtLevel></uswx:results><uswx:results><uswx:WindTempAtLevel lightAndVariable="true"><uswx:temperature uom="Cel">2</uswx:temperature><uswx:level uom="[ft_i]">15000</uswx:level></uswx:WindTempAtLevel></uswx:results><uswx:results><uswx:WindTempAtLevel lightAndVariable="true"><uswx:temperature uom="Cel">-5</uswx:temperature><uswx:level uom="[ft_i]">18000</uswx:level></uswx:WindTempAtLevel></uswx:results><uswx:results><uswx:WindTempAtLevel><uswx:windDirection uom="deg">280</uswx:windDirection><uswx:windSpeed uom="[kn_i]">23</uswx:windSpeed><uswx:temperature uom="Cel">-16</uswx:temperature><uswx:level uom="[ft_i]">24000</uswx:level></uswx:WindTempAtLevel></uswx:results></uswx:SamplingAtPoint></uswx:WTForecastResults><uswx:WTForecastResults><uswx:SamplingAtPoint><uswx:samplingPointIdentifier>KOA</uswx:samplingPointIdentifier><uswx:samplingPointLocation><gml:Point gml:id="wta-a36a2138-2c09-473e-bd0d-916531537b02" axisLabels="Lat Long" srsDimension="2" srsName="http://www.opengis.net/def/crs/EPSG/0/4326"><gml:pos>19.733 -155.950</gml:pos></gml:Point></uswx:samplingPointLocation><uswx:results><uswx:WindTempAtLevel><uswx:windDirection uom="deg">60</uswx:windDirection><uswx:windSpeed uom="[kn_i]">5</uswx:windSpeed><uswx:level uom="[ft_i]">1000</uswx:level></uswx:WindTempAtLevel></uswx:results><uswx:results><uswx:WindTempAtLevel><uswx:windDirection uom="deg">70</uswx:windDirection><uswx:windSpeed uom="[kn_i]">6</uswx:windSpeed><uswx:level uom="[ft_i]">1500</uswx:level></uswx:WindTempAtLevel></uswx:results><uswx:results><uswx:WindTempAtLevel lightAndVariable="true"><uswx:level uom="[ft_i]">2000</uswx:level></uswx:WindTempAtLevel></uswx:results><uswx:results><uswx:WindTempAtLevel lightAndVariable="true"><uswx:level uom="[ft_i]">3000</uswx:level></uswx:WindTempAtLevel></uswx:results><uswx:results><uswx:WindTempAtLevel lightAndVariable="true"><uswx:temperature uom="Cel">14</uswx:temperature><uswx:level uom="[ft_i]">6000</uswx:level></uswx:WindTempAtLevel></uswx:results><uswx:results><uswx:WindTempAtLevel lightAndVariable="true"><uswx:temperature uom="Cel">10</uswx:temperature><uswx:level uom="[ft_i]">9000</uswx:level></uswx:WindTempAtLevel></uswx:results><uswx:results><uswx:WindTempAtLevel lightAndVariable="true"><uswx:temperature uom="Cel">7</uswx:temperature><uswx:level uom="[ft_i]">12000</uswx:level></uswx:WindTempAtLevel></uswx:results><uswx:results><uswx:WindTempAtLevel lightAndVariable="true"><uswx:temperature uom="Cel">3</uswx:temperature><uswx:level uom="[ft_i]">15000</uswx:level></uswx:WindTempAtLevel></uswx:results><uswx:results><uswx:WindTempAtLevel lightAndVariable="true"><uswx:temperature uom="Cel">-4</uswx:temperature><uswx:level uom="[ft_i]">18000</uswx:level></uswx:WindTempAtLevel></uswx:results><uswx:results><uswx:WindTempAtLevel><uswx:windDirection uom="deg">280</uswx:windDirection><uswx:windSpeed uom="[kn_i]">20</uswx:windSpeed><uswx:temperature uom="Cel">-16</uswx:temperature><uswx:level uom="[ft_i]">24000</uswx:level></uswx:WindTempAtLevel></uswx:results></uswx:SamplingAtPoint></uswx:WTForecastResults><uswx:WTForecastResults><uswx:SamplingAtPoint><uswx:samplingPointIdentifier>ITO</uswx:samplingPointIdentifier><uswx:samplingPointLocation><gml:Point gml:id="wta-a36a2138-2c09-473e-bd0d-916531537b02" axisLabels="Lat Long" srsDimension="2" srsName="http://www.opengis.net/def/crs/EPSG/0/4326"><gml:pos>19.717 -154.950</gml:pos></gml:Point></uswx:samplingPointLocation><uswx:results><uswx:WindTempAtLevel lightAndVariable="true"><uswx:level uom="[ft_i]">1000</uswx:level></uswx:WindTempAtLevel></uswx:results><uswx:results><uswx:WindTempAtLevel><uswx:windDirection uom="deg">70</uswx:windDirection><uswx:windSpeed uom="[kn_i]">5</uswx:windSpeed><uswx:level uom="[ft_i]">1500</uswx:level></uswx:WindTempAtLevel></uswx:results><uswx:results><uswx:WindTempAtLevel><uswx:windDirection uom="deg">70</uswx:windDirection><uswx:windSpeed uom="[kn_i]">6</uswx:windSpeed><uswx:level uom="[ft_i]">2000</uswx:level></uswx:WindTempAtLevel></uswx:results><uswx:results><uswx:WindTempAtLevel><uswx:windDirection uom="deg">100</uswx:windDirection><uswx:windSpeed uom="[kn_i]">13</uswx:windSpeed><uswx:level uom="[ft_i]">3000</uswx:level></uswx:WindTempAtLevel></uswx:results><uswx:results><uswx:WindTempAtLevel><uswx:windDirection uom="deg">110</uswx:windDirection><uswx:windSpeed uom="[kn_i]">10</uswx:windSpeed><uswx:temperature uom="Cel">12</uswx:temperature><uswx:level uom="[ft_i]">6000</uswx:level></uswx:WindTempAtLevel></uswx:results><uswx:results><uswx:WindTempAtLevel><uswx:windDirection uom="deg">100</uswx:windDirection><uswx:windSpeed uom="[kn_i]">7</uswx:windSpeed><uswx:temperature uom="Cel">9</uswx:temperature><uswx:level uom="[ft_i]">9000</uswx:level></uswx:WindTempAtLevel></uswx:results><uswx:results><uswx:WindTempAtLevel><uswx:windDirection uom="deg">100</uswx:windDirection><uswx:windSpeed uom="[kn_i]">10</uswx:windSpeed><uswx:temperature uom="Cel">9</uswx:temperature><uswx:level uom="[ft_i]">12000</uswx:level></uswx:WindTempAtLevel></uswx:results><uswx:results><uswx:WindTempAtLevel><uswx:windDirection uom="deg">130</uswx:windDirection><uswx:windSpeed uom="[kn_i]">11</uswx:windSpeed><uswx:temperature uom="Cel">2</uswx:temperature><uswx:level uom="[ft_i]">15000</uswx:level></uswx:WindTempAtLevel></uswx:results><uswx:results><uswx:WindTempAtLevel><uswx:windDirection uom="deg">10</uswx:windDirection><uswx:windSpeed uom="[kn_i]">5</uswx:windSpeed><uswx:temperature uom="Cel">-4</uswx:temperature><uswx:level uom="[ft_i]">18000</uswx:level></uswx:WindTempAtLevel></uswx:results><uswx:results><uswx:WindTempAtLevel><uswx:windDirection uom="deg">270</uswx:windDirection><uswx:windSpeed uom="[kn_i]">19</uswx:windSpeed><uswx:temperature uom="Cel">-15</uswx:temperature><uswx:level uom="[ft_i]">24000</uswx:level></uswx:WindTempAtLevel></uswx:results></uswx:SamplingAtPoint></uswx:WTForecastResults></uswx:WindsAndTemperaturesAloftForecast>
'''  # noqa: E501
